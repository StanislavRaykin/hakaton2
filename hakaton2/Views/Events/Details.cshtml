@model hakaton2.Models.Models.EventViewModel;
@{
    ViewBag.Title = (Model?.Title ?? "Event") + " - EcoPoints";
    Layout = "~/Views/Shared/_Layout.cshtml";

    DateTime? start = null, end = null;
    try { start = Model?.Start; } catch { }
    try { end = Model?.End; } catch { }
}

<div class="container my-5">
    <div class="row mb-3">
        <div class="col-12">
            <a href="@Url.Action("Index","Events")" class="btn btn-sm btn-outline-secondary mb-3">← Обратно към събитията</a>

            <div class="card">
                <div class="card-body">
                    <h2 class="card-title text-success">@Model.Title</h2>
                    @if (start != null)
                    {
                        <p class="text-muted">@start.Value.ToString("f")@(end != null ? " — " + end.Value.ToString("f") : "")</p>
                    }
                    <p>@Model.Description</p>

                    <hr />
                    <!-- Join / Increment participant button: posts to EventsController.IncrementParticipant -->
                    @if (Model != null)
                    {
                        @* Optional success message from controller *@
                       

                        <form method="post" action='@Url.Action("IncrementParticipant", "Event")' class="d-inline-block">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="eventId" value="@Model.EventId" />
                            <button type="submit" class="btn btn-success" onclick="return confirm('Сигурни ли сте, че искате да се присъедините към това събитие?')">Присъедини се към събитието</button>
                        </form>

                        @* Optional: a cancel / share button *@
                        <a href="@Url.Action("Index","Events")" class="btn btn-outline-secondary ms-2">Откажи</a>
                    }

                </div>
            </div>
        </div>
    </div>
</div>

@* PSEUDOCODE / PLAN:
   - Read TempData["JoinResult"] which contains the boolean result from the POST action.
   - If TempData["JoinResult"] exists:
       - Safely convert it to bool.
       - If true -> render a success alert "Успешно се присъединихте към събитието."
       - If false -> render a danger alert "Събитието е пълно."
   - If TempData["JoinResult"] is not present but TempData["JoinSuccess"] exists (legacy), render that message as success.
   - Then render the join form unchanged (anti-forgery, hidden eventId, confirm on click).
*@

@{
    // Safely extract possible TempData results
    object joinResultObj = TempData["JoinResult"];
    bool? joinResultBool = null;
    if (joinResultObj != null)
    {
        try { joinResultBool = Convert.ToBoolean(joinResultObj); } catch { joinResultBool = null; }
    }
}

@if (joinResultBool != null)
{
    if (joinResultBool.Value)
    {
        <div class="alert alert-success">Успешно се присъединихте към събитието.</div>
    }
    else
    {
        <div class="alert alert-danger">Събитието е пълно.</div>
    }
}


