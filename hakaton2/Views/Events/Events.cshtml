@using System.Linq
@using System.Collections
@model List<hakaton2.Models.Models.EventViewModel>

@{
    ViewBag.Title = "Events - EcoPoints";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var actives = Model
        .Where(e => e.Start <= DateTime.Now && (e.End == null || e.End >= DateTime.Now))
        .OrderBy(e => e.Start)
        .ToList();//currently active eventss

    // var source = Model ?? (ViewData["Events"] as IEnumerable<dynamic>) ?? Enumerable.Empty<dynamic>();
    // var items = source.ToList();

    // Func<dynamic, string[], string> GetString = (item, names) =>
    // {
    //     if (item == null) return string.Empty;
    //     var t = item.GetType();
    //     foreach (var n in names)
    //     {
    //         var prop = t.GetProperty(n);
    //         if (prop != null) { var v = prop.GetValue(item); return v?.ToString() ?? string.Empty; }
    //         var field = t.GetField(n);
    //         if (field != null) { var v = field.GetValue(item); return v?.ToString() ?? string.Empty; }
    //         if (item is IDictionary dict && dict.Contains(n)) { var v = dict[n]; return v?.ToString() ?? string.Empty; }
    //     }
    //     return string.Empty;
    // };

    // Func<dynamic, string[], DateTime?> GetDate = (item, names) =>
    // {
    //     if (item == null) return null;
    //     var t = item.GetType();
    //     foreach (var n in names)
    //     {
    //         var prop = t.GetProperty(n);
    //         if (prop != null)
    //         {
    //             var v = prop.GetValue(item);
    //             if (v is DateTime dt) return dt;
    //             if (DateTime.TryParse(v?.ToString(), out DateTime parsed)) return parsed;
    //         }
    //         var field = t.GetField(n);
    //         if (field != null)
    //         {
    //             var v = field.GetValue(item);
    //             if (v is DateTime dt) return dt;
    //             if (DateTime.TryParse(v?.ToString(), out DateTime parsed)) return parsed;
    //         }
    //         if (item is IDictionary dict && dict.Contains(n))
    //         {
    //             var v = dict[n];
    //             if (v is DateTime dt) return dt;
    //             if (DateTime.TryParse(v?.ToString(), out DateTime parsed)) return parsed;
    //         }
    //     }
    //     return null;
    // };

    // var now = DateTime.Now;
    // var eventsWithDates = items
    //     .Select(i => new
    //     {
    //         Item = i,
    //         Title = GetString(i, new[] { "Title", "Name", "EventName" }),
    //         Description = GetString(i, new[] { "Description", "Summary", "Details" }),
    //         Start = (DateTime?)GetDate(i, new[] { "Start", "StartDate", "Date", "EventDate" }),
    //         End = (DateTime?)GetDate(i, new[] { "End", "EndDate", "Finish", "EndTime" })
    //     })
    //     .Where(x => x.Start != null)
    //     .ToList();

    // var past = eventsWithDates
    //     .Where(x => (x.End.HasValue ? x.End.Value < now : x.Start.Value < now))
    //     .OrderByDescending(x => x.Start)
    //     .ToList();

    // var last = past.FirstOrDefault();

    // var active = eventsWithDates
    //     .Where(x => x.Start <= now && (x.End == null || x.End >= now))
    //     .OrderBy(x => x.Start)
    //     .ToList();

    var upcoming = Model
        .Where(x => x.Start > DateTime.Now)
        .OrderBy(x => x.Start)
        .ToList();

    var past = Model
       .Where(x => x.End < DateTime.Now)
       .OrderBy(x => x.Start)
       .ToList();

}

<div class="container mt-5">
    <div class="row mb-3">
        <div class="col-12 text-center">
            <h1 class="text-success">Събития</h1>
            <hr />
        </div>
    </div>

   

    <!-- Active events (stacked) -->
    <div class="row mb-4">
        <div class="col-12">
            <h4>Активни:</h4>
            
            @if (!actives.Any())
            {
                <div class="alert alert-secondary">Няма активни събития.</div>
            }
            else
            {
                @foreach (var e in actives)
                {

                    <div class="card mb-2 border-success">
                        <div class="card-body">
                            <h5 class="card-title">@e.Title</h5>
                            <h6 class="card-subtitle mb-2 text-muted">@e.Start.Value.ToString("f")@(e.End.HasValue ? " — " + e.End.Value.ToString("f") : "")</h6>
                            <p class="card-text">@e.Description</p>
                            <a class="btn btn-sm btn-outline-success" href="@Url.Action("Details", "Events", new { id = e.EventId })">Прочети повече</a>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Upcoming events (stacked list) -->
    <div class="row mb-4">
        <div class="col-12">
            <h4>Предстоящи събития</h4>
            @if (!upcoming.Any())
            {
                <div class="alert alert-secondary">Няма събития.</div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var u in upcoming)
                    {
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                            <div class="me-3">
                                <div class="fw-bold">@u.Title</div>
                                <small class="text-muted">@u.Start.Value.ToString("f")@(u.End.HasValue ? " — " + u.End.Value.ToString("f") : "")</small>
                                <div class="small mt-1">@u.Description</div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary rounded-pill">@Math.Max(0, (u.Start.Value - DateTime.Now).Days) d</span>
                                <div class="mt-2">
                                    <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Details", "Events", new { id = u.EventId })">Прочети повече</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-12">
            <h4>Минали събития</h4>
            @if (!past.Any())
            {
                <div class="alert alert-secondary">Няма събития.</div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var u in past)
                    {
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start">
                            <div class="me-3">
                                <div class="fw-bold">@u.Title</div>
                                <small class="text-muted">@u.Start.Value.ToString("f")@(u.End.HasValue ? " — " + u.End.Value.ToString("f") : "")</small>
                                <div class="small mt-1">@u.Description</div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary rounded-pill">@Math.Max(0, (u.Start.Value - DateTime.Now).Days) d</span>
                                <div class="mt-2">
                                    <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Details", "Events", new { id = u.EventId })">Прочети повече</a>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>